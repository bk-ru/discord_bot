# Class Reference

---

## database/models.py

### `User`
- **Назначение:** ORM-модель Tortoise для хранения основных данных пользователя Discord (ID, ФИО, учебная группа).
- **Связи:** Имеет отношение «один ко многим» с `LabWork` через внешние ключи в базе; используется `LabsCog` и вспомогательные сервисы при работе со студентами.
- **Расположение:** Файл `database/models.py` содержит все сущности, описывающие схему базы данных, поэтому модель пользователя располагается именно здесь.

### `LabWork`
- **Назначение:** ORM-модель, представляющая лабораторную работу студента (номер, ссылка на исходный файл, статус, комментарии преподавателя, исправленный файл и служебные идентификаторы).
- **Связи:** Ссылается на `User` (внешний ключ). Используется `LabsCog`, `LabReviewView`, `FeedbackModal` для учёта отправок и отзывов.
- **Расположение:** Через Tortoise ORM схема лежит рядом с `User`, потому что обе модели описывают данные слоя `database`.

---

## cogs/events.py

### `EventsCog` (`commands.Cog`)
- **Назначение:** Автоматическая обработка событий Discord (инициализация по готовности, отслеживание входа/выхода, выдача ролей, создание каналов, старт диалога регистрации).
- **Ключевые методы:**
  - `on_ready` — подключение к БД, подготовка Excel, создание служебных каналов и начальная синхронизация пользователей.
  - `on_member_join`, `on_member_remove` — корректировка ролей и уведомлений при изменении состава гильдии.
  - `send_help_message`, `start_registration_dialog`, `assign_group_role_and_channels`, `sync_users_from_guild` — вспомогательные сценарии регистрации и маршрутизации студентов.
  - `get_or_create_role`, `setup_unknown_role_and_channel`, `get_or_create_feedback_channel`, `log_action` — инфраструктурные операции с ролями и логами.
- **Связи:** 
  - Использует UI-компоненты `ChannelConflictView` и `DeleteChannelView` (из `cogs/views`) для интерактивных действий с каналами.
  - Запросы к вспомогательным функциям `ensure_feedback_channel`, `send_feedback_message` (из `utils/feedback.py`).
  - Работает совместно с утилитами `utils/file_manager`.
- **Расположение:** В папке `cogs/` сосредоточены модули-«когти» (`commands.Cog`), логически объединяющие обработчики событий и команд. `EventsCog` отвечает за общегильдейские события, поэтому находится в `cogs/events.py`.

---

## cogs/commands.py

### `GroupManagementCog` (`commands.Cog`)
- **Назначение:** Администрирование учебных групп через чат-команды (`!addgroup`, `!removegroup`).
- **Ключевые методы:** 
  - `add_group`, `remove_group` — создание и удаление ролей, категорий и каналов групп.
  - `add_group_error`, `remove_group_error` — обработка исключений и недостатка прав.
- **Связи:** Пользуется `utils/file_manager` (Excel), функциями логирования обратной связи (`utils.feedback`). Взаимодействует с Discord API (создание/редактирование ролей, каналов).
- **Расположение:** Папка `cogs/` содержит тематические наборы команд. Данный ког управляет структурами групп, поэтому логично расположен в `cogs/commands.py`.

---

## cogs/general_commands.py

### `GeneralCommands` (`commands.Cog`)
- **Назначение:** Базовые команды бота (`!info`, `!ping`, заглушка `!verify`).
- **Ключевые методы:** `info`, `ping`, `verify`.
- **Связи:** Работает только с контекстом `commands.Context` и объектом `Bot`.
- **Расположение:** Общие команды — отдельный ког в `cogs/general_commands.py`, чтобы отделить пользовательские функции от админских.

### `HelpCog` (`commands.Cog`)
- **Назначение:** Реализация пользовательской справки (`!help`) с динамическим составом секций в зависимости от ролей.
- **Ключевые методы:** `help_command`.
- **Связи:** Конструирует `discord.Embed`, анализирует роли пользователя, опирается на другие коги (описание команд).
- **Расположение:** Находится рядом с `GeneralCommands`, потому что обе логики обслуживают конечного пользователя и загружаются вместе.

---

## cogs/commands_labs.py

### `LabsCog` (`commands.Cog`)
- **Назначение:** Главный ког для работы с лабораторными: отправка, проверка, выдача комментариев, ссылки на файлы, повторная загрузка и администрирование.
- **Ключевые методы (группами):**
  - Пользовательские команды: `submit_lab`, `status_lab`, `labs`.
  - Административные: `review_lab`, `accept_lab`, `delete_lab`, `lab_file`, `resubmit_lab`.
  - Вспомогательные: `_ensure_user`, `_get_or_create_feedback_channel`, `_log_feedback`, `get_or_create_teacher_channel`, `_post_to_teacher_channel`.
  - Обработка пересылки файлов и логирования: методы активно используют Tortoise ORM и каналы обратной связи.
- **Связи:** 
  - ORM-модели `User` и `LabWork`.
  - UI-компоненты `LabReviewView`, `FeedbackModal` (из `cogs/labs/views.py`).
  - Утилиты `ensure_feedback_channel`, `send_feedback_message`.
  - Работает совместно с `EventsCog` (обе коги используют единые каналы логов) и групповой инфраструктурой.
- **Расположение:** `cogs/commands_labs.py` отделён как крупный модуль команд, относящийся к лабораторным работам. Это облегчает поддержку, так как весь «производственный» функционал сконцентрирован в одном когe.

---

## cogs/views/channel_conflict.py

### `ChannelConflictView` (`discord.ui.View`)
- **Назначение:** UI-кнопки для выбора стратегии при обнаружении нескольких «личных» каналов студента (создание нового / добавление в существующий).
- **Ключевые методы:** `create_new`, `add_to_existing`, `_delete_original_message`.
- **Связи:** 
  - Используется `EventsCog` при обработке регистрации.
  - Доступ к логам через `send_feedback_message`.
- **Расположение:** В подкаталоге `cogs/views/` собраны все пользовательские интерфейсные компоненты (кнопки, модальные формы), чтобы разделить их от логики когов.

---

## cogs/views/delete_channel.py

### `DeleteChannelView` (`discord.ui.View`)
- **Назначение:** Предлагает администратору удалить или сохранить личный канал после ухода студента.
- **Ключевые методы:** `delete_channel`, `keep_channel`, `_delete_original_message`.
- **Связи:** Вызывается `EventsCog`, при действии пишет логи в feedback-канал.
- **Расположение:** Размещён в `cogs/views/` рядом с другими UI-компонентами.

---

## cogs/labs/views.py

### `LabReviewView` (`discord.ui.View`)
- **Назначение:** Кнопки для преподавателя в приватном канале лабораторной (принять или отправить на доработку).
- **Ключевые методы:** 
  - `_process_result` — общая логика обновления `LabWork` и уведомлений.
  - `accept`, `review` — кнопки интерфейса.
  - Вспомогательные (`_collect_corrected_file`, `_notify_student_and_channel`, `_delete_teacher_message`) обрабатывают файлы и синхронизацию.
- **Связи:** 
  - Работает с моделью `LabWork` (обновляет статус).
  - Создаётся `LabsCog`.
  - При нажатии «На доработку» показывает `FeedbackModal`.
  - Отправляет логи через `utils.feedback`.
- **Расположение:** Файл `cogs/labs/views.py` содержит UI-компоненты, относящиеся к процессу проверки лабораторных. Они отделены от основной логики cog-а ради читаемости.

### `FeedbackModal` (`discord.ui.Modal`)
- **Назначение:** Форма для ввода комментария преподавателя при возврате на доработку.
- **Ключевые методы:** `on_submit` — передаёт введённый текст в `LabReviewView`.
- **Связи:** Включается `LabReviewView`, обновляет `LabWork`, пишет логи.
- **Расположение:** В той же папке, что и `LabReviewView`, как часть UI-потока для преподавателей.

---

## cogs/labs/__init__.py

### Re-export объекта `safe_respond`, `LabReviewView`, `FeedbackModal`
- **Назначение:** Упрощает импорт компонентов лабораторного UI (например, в `LabsCog`).
- **Расположение:** Корневой пакет подмодуля «labs», чтобы предоставить единый интерфейс к его частям.

---

## cogs/labs/utils.py

### (Функции, класс отсутствует)
- Классов нет; файл содержит вспомогательную функцию `safe_respond`, поэтому в контексте данного документа пропускается.

---

## cogs/views/__init__.py

### Re-export `ChannelConflictView`, `DeleteChannelView`
- Обеспечивает компактный импорт UI-кнопок в других частях проекта.

---

## docs/class_diagram.puml

- Файл не содержит классов, но предоставляет диаграмму, которая соответствует описанию выше.

---

## Итоговые зависимости

- Все коги наследуются от `commands.Cog`, чтобы бот мог динамически загружать и разгружать их.
- `EventsCog`, `GroupManagementCog`, `LabsCog` и UI-компоненты делят общие утилиты (`utils.feedback`) для logging-а в feedback-канал.
- Расслоение по подпапкам (`cogs/`, `cogs/views/`, `cogs/labs/`, `database/`, `utils/`) отражает архитектурные роли: команды, UI-компоненты, специфическая логика лабораторных, модели данных и вспомогательные функции.

Файл поддерживает актуальный список классов и может дополняться при появлении новых сущностей.
